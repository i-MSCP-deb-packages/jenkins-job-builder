- job-template:
    name: '{repo}_{package}-source'
    project-type: matrix
    execution-strategy:
      sequential: '{obj:sequential}'
    scm:
      - git:
          url: '{git-url}'
          name: origin
          refspec: +refs/heads/*:refs/remotes/origin/*
          basedir: source
          branches: '{obj:branches}'
          wipe-workspace: false
    axes:
      - axis:
          type: user-defined
          name: distribution
          values: '{obj:distributions}'
    builders:
      - shell: |
          rm -f ./* || true
      - shell: |
          export distribution=${{distribution}}
          /usr/bin/generate-git-snapshot
      - shell: |
          mkdir -p report
          /usr/bin/lintian-junit-report *.dsc > report/lintian.xml
    publishers:
      - archive:
          artifacts: '*.gz,*.bz2,*.xz,*.deb,*.dsc,*.git,*.changes,lintian.txt'
      - trigger:
          project: '{repo}_{package}-binaries'
      - junit:
          results: '**/lintian.xml'
          keep-long-stdio: false
      - fingerprint:
          record-artifacts: true
    properties:
      - build-discarder:
          num-to-keep: 3
          artifact-num-to-keep: 1
      
- job-template:
    name: '{repo}_{package}-binaries'
    project-type: matrix
    description: |
      <p>Build Debian binary packages of {package}.<br />Do not edit this job through the web, it is generated via jenkins-job-builder!</p>
      <h2>Usage instructions how to remotely access and use the repository (as root user):</h2>
      <pre>
      apt-get install lsb-release apt-transport-https
      wget -O /etc/apt/trusted.gpg.d/{repo}.gpg https://packages.sury.org/{repo}_apt.gpg
      cat << EOF > /etc/apt/sources.list.d/{repo}.list
      deb     https://packages.sury.org/{repo} $(lsb_release -cs) main
      #deb-src https://packages.sury.org/{repo} $(lsb_release -cs) main
      EOF
      apt-get update
      </pre>
    execution-strategy:
      sequential: '{obj:sequential}'
    axes:
      - axis:
          type: user-defined
          name: architecture
          values: '{obj:architectures}'
      - axis:
          type: user-defined
          name: distribution
          values: '{obj:distributions}'
    builders:
      - copyartifact:
          project: '{repo}_{package}-source/distribution=${{distribution}}'
          filter: '*'
          which-build: upstream-build
          fallback-to-last-successful: true
      - shell: |
          export POST_BUILD_HOOK=/usr/bin/jdg-debc
          export release=$distribution
          export RELEASE_REPOSITORY=/srv/repository/{repo}
          export RELEASE_DISTRIBUTION=$distribution
          /usr/bin/build-and-provide-package
      - shell: |
          export REPOSITORY=/srv/repository/{repo}
          echo "Listing packages inside the {repo} repository:"
          /usr/bin/repository_checker --list-repos $distribution
      - shell: |
          mkdir -p report
          /usr/bin/lintian-junit-report *.dsc > report/lintian.xml
    publishers:
      - archive:
          artifacts: '*.gz,*.bz2,*.xz,*.deb,*.dsc,*.git,*.changes,lintian.txt'
      - junit:
          results: '**/lintian.xml'
          keep-long-stdio: false
      - fingerprint:
          record-artifacts: true
      - trigger:
          project: '{repo}_{package}-piuparts'
      - workspace-cleanup:
          dirmatch: false
    wrappers:
      - timestamps
    properties:
      - build-discarder:
          num-to-keep: 3
          artifact-num-to-keep: 1

- job-template:
    name: '{repo}_{package}-piuparts'
    project-type: freestyle
    description: 'Installation and upgrade tests for {package} Debian packages.<br />Do not edit this job through the web, it is generated via jenkins-job-builder!'
    disabled: false
    parameters:
      - string:
          name: architecture
          default: amd64
          description: "Architecture that should be used."
      - string:
          name: distribution
          default: jessie
          description: "Distribution that should be used."
    builders:
      - copyartifact:
          project: '{repo}_{package}-binaries/architecture=${{architecture}},distribution=${{distribution}}'
          filter: '*.deb'
          which-build: upstream-build
          fallback-to-last-successful: true
          flatten: true
          target: 'artifacts/'
      - shell: |
          # sadly piuparts always returns with exit code 1 :((
          sudo piuparts_wrapper ${{PWD}}/artifacts/*.deb || true
      - shell: |
          piuparts_tap piuparts.txt > piuparts.tap
    publishers:
      - tap:
          results: 'piuparts.tap'
      - archive:
          artifacts: 'piuparts.*'
      - fingerprint:
          record-artifacts: true
      - workspace-cleanup:
          dirmatch: false
    wrappers:
      - timestamps
    properties:
      - build-discarder:
          num-to-keep: 3
          artifact-num-to-keep: 1
